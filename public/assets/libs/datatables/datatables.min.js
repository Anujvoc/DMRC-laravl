/**
 * DataTables - Minimal implementation for data tables
 * Basic table functionality for admin dashboard
 */

window.DataTable = window.DataTable || function(selector, options = {}) {
    const table = typeof selector === 'string' ? 
        document.querySelector(selector) : 
        selector;
    
    const defaultOptions = {
        paging: true,
        searching: true,
        ordering: true,
        info: true,
        pageLength: 10,
        responsive: true
    };
    
    const config = { ...defaultOptions, ...options };
    
    return {
        table: table,
        config: config,
        
        init: function() {
            this.createControls();
            this.bindEvents();
            this.processTable();
        },
        
        createControls: function() {
            const wrapper = document.createElement('div');
            wrapper.className = 'dataTables_wrapper';
            
            // Create search box
            if (config.searching) {
                const searchDiv = document.createElement('div');
                searchDiv.className = 'dataTables_filter';
                searchDiv.innerHTML = `
                    <label>
                        Search:
                        <input type="search" class="form-control form-control-sm" placeholder="">
                    </label>
                `;
                wrapper.appendChild(searchDiv);
            }
            
            // Create length selector
            if (config.paging) {
                const lengthDiv = document.createElement('div');
                lengthDiv.className = 'dataTables_length';
                lengthDiv.innerHTML = `
                    <label>
                        Show 
                        <select class="form-select form-select-sm">
                            <option value="10" ${config.pageLength === 10 ? 'selected' : ''}>10</option>
                            <option value="25" ${config.pageLength === 25 ? 'selected' : ''}>25</option>
                            <option value="50" ${config.pageLength === 50 ? 'selected' : ''}>50</option>
                            <option value="100" ${config.pageLength === 100 ? 'selected' : ''}>100</option>
                        </select>
                        entries
                    </label>
                `;
                wrapper.appendChild(lengthDiv);
            }
            
            // Wrap table
            table.parentNode.insertBefore(wrapper, table);
            wrapper.appendChild(table);
            
            // Create info and pagination
            if (config.paging) {
                const infoDiv = document.createElement('div');
                infoDiv.className = 'dataTables_info';
                wrapper.appendChild(infoDiv);
                
                const paginateDiv = document.createElement('div');
                paginateDiv.className = 'dataTables_paginate';
                wrapper.appendChild(paginateDiv);
            }
        },
        
        bindEvents: function() {
            const wrapper = table.closest('.dataTables_wrapper');
            
            // Search functionality
            if (config.searching) {
                const searchInput = wrapper.querySelector('.dataTables_filter input');
                searchInput.addEventListener('keyup', () => {
                    this.search(searchInput.value);
                });
            }
            
            // Length selector
            if (config.paging) {
                const lengthSelect = wrapper.querySelector('.dataTables_length select');
                lengthSelect.addEventListener('change', () => {
                    config.pageLength = parseInt(lengthSelect.value);
                    this.processTable();
                });
            }
        },
        
        search: function(query) {
            const rows = table.querySelectorAll('tbody tr');
            const searchTerm = query.toLowerCase();
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
            
            this.updateInfo();
        },
        
        processTable: function() {
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            const visibleRows = rows.filter(row => row.style.display !== 'none');
            
            if (config.paging) {
                this.paginate(visibleRows);
            }
            
            this.updateInfo();
        },
        
        paginate: function(rows) {
            const totalPages = Math.ceil(rows.length / config.pageLength);
            let currentPage = 1;
            
            function showPage(page) {
                rows.forEach((row, index) => {
                    row.style.display = (index >= (page - 1) * config.pageLength && index < page * config.pageLength) ? '' : 'none';
                });
                currentPage = page;
                this.updatePagination(currentPage, totalPages);
            }
            
            showPage.call(this, 1);
        },
        
        updatePagination: function(currentPage, totalPages) {
            const wrapper = table.closest('.dataTables_wrapper');
            const paginateDiv = wrapper.querySelector('.dataTables_paginate');
            
            let paginationHTML = '<div class="pagination">';
            
            // Previous button
            paginationHTML += `
                <button class="paginate_button previous ${currentPage === 1 ? 'disabled' : ''}" 
                        ${currentPage === 1 ? 'disabled' : ''}>
                    Previous
                </button>
            `;
            
            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHTML += `
                        <button class="paginate_button ${i === currentPage ? 'current' : ''}" 
                                data-page="${i}">
                            ${i}
                        </button>
                    `;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHTML += '<span class="ellipsis">...</span>';
                }
            }
            
            // Next button
            paginationHTML += `
                <button class="paginate_button next ${currentPage === totalPages ? 'disabled' : ''}" 
                        ${currentPage === totalPages ? 'disabled' : ''}>
                    Next
                </button>
            `;
            
            paginationHTML += '</div>';
            paginateDiv.innerHTML = paginationHTML;
            
            // Bind pagination events
            paginateDiv.querySelectorAll('.paginate_button:not(.disabled)').forEach(button => {
                button.addEventListener('click', () => {
                    const page = button.dataset.page ? parseInt(button.dataset.page) : 
                                button.classList.contains('previous') ? currentPage - 1 : 
                                button.classList.contains('next') ? currentPage + 1 : currentPage;
                    this.paginate(Array.from(table.querySelectorAll('tbody tr')).filter(row => row.style.display !== 'none'));
                });
            });
        },
        
        updateInfo: function() {
            if (!config.info) return;
            
            const wrapper = table.closest('.dataTables_wrapper');
            const infoDiv = wrapper.querySelector('.dataTables_info');
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            const visibleRows = rows.filter(row => row.style.display !== 'none');
            
            const start = visibleRows.length > 0 ? 1 : 0;
            const end = visibleRows.length;
            const total = rows.length;
            
            infoDiv.textContent = `Showing ${start} to ${end} of ${total} entries`;
        },
        
        destroy: function() {
            const wrapper = table.closest('.dataTables_wrapper');
            if (wrapper) {
                wrapper.parentNode.insertBefore(table, wrapper);
                wrapper.remove();
            }
        }
    };
};
