/**
 * Flatpickr - Minimal date picker implementation
 * Basic date picker functionality for admin dashboard
 */

window.flatpickr = window.flatpickr || function(selector, options = {}) {
    const elements = typeof selector === 'string' ? 
        document.querySelectorAll(selector) : 
        [selector];
    
    const defaultOptions = {
        dateFormat: 'Y-m-d',
        enableTime: false,
        time_24hr: true,
        defaultDate: 'today',
        locale: {
            firstDayOfWeek: 1,
            weekdays: {
                shorthand: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                longhand: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']
            },
            months: {
                shorthand: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                longhand: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']
            }
        }
    };
    
    const config = { ...defaultOptions, ...options };
    
    return Array.from(elements).map(element => {
        const input = element;
        let calendar = null;
        let isOpen = false;
        
        function createCalendar() {
            calendar = document.createElement('div');
            calendar.className = 'flatpickr-calendar';
            calendar.style.position = 'absolute';
            calendar.style.zIndex = '9999';
            calendar.style.display = 'none';
            calendar.style.background = 'white';
            calendar.style.border = '1px solid #ddd';
            calendar.style.borderRadius = '4px';
            calendar.style.padding = '10px';
            calendar.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
            
            document.body.appendChild(calendar);
            
            // Simple calendar content
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            
            calendar.innerHTML = `
                <div class="flatpickr-month">
                    <div class="flatpickr-current-month">
                        <select class="flatpickr-monthDropdown-months">
                            ${config.locale.months.longhand.map((monthName, index) => 
                                `<option value="${index}" ${index === month ? 'selected' : ''}>${monthName}</option>`
                            ).join('')}
                        </select>
                        <input class="flatpickr-current-month-year" type="number" value="${year}" min="1900" max="2100">
                    </div>
                </div>
                <div class="flatpickr-days">
                    <div class="dayContainer">
                        ${generateCalendarDays(year, month)}
                    </div>
                </div>
            `;
            
            // Add event listeners
            calendar.addEventListener('click', function(e) {
                if (e.target.classList.contains('flatpickr-day')) {
                    const selectedDate = e.target.dataset.date;
                    input.value = selectedDate;
                    closeCalendar();
                    
                    if (config.onChange) {
                        config.onChange(selectedDate, input);
                    }
                }
            });
        }
        
        function generateCalendarDays(year, month) {
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            
            let html = '<div class="flatpickr-weekdays">';
            for (let i = 0; i < 7; i++) {
                html += `<div class="flatpickr-weekday">${config.locale.weekdays.shorthand[i]}</div>`;
            }
            html += '</div><div class="flatpickr-daysContainer">';
            
            // Empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="flatpickr-day disabled"></div>';
            }
            
            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = date.toDateString() === today.toDateString();
                
                html += `<div class="flatpickr-day ${isToday ? 'today' : ''}" data-date="${dateStr}">${day}</div>`;
            }
            
            html += '</div>';
            return html;
        }
        
        function openCalendar() {
            if (!calendar) {
                createCalendar();
            }
            
            const rect = input.getBoundingClientRect();
            calendar.style.top = `${rect.bottom + window.scrollY}px`;
            calendar.style.left = `${rect.left + window.scrollX}px`;
            calendar.style.display = 'block';
            isOpen = true;
        }
        
        function closeCalendar() {
            if (calendar) {
                calendar.style.display = 'none';
            }
            isOpen = false;
        }
        
        function toggleCalendar() {
            if (isOpen) {
                closeCalendar();
            } else {
                openCalendar();
            }
        }
        
        // Event listeners
        input.addEventListener('click', toggleCalendar);
        input.addEventListener('focus', openCalendar);
        
        document.addEventListener('click', function(e) {
            if (!input.contains(e.target) && (!calendar || !calendar.contains(e.target))) {
                closeCalendar();
            }
        });
        
        return {
            close: closeCalendar,
            open: openCalendar,
            destroy: function() {
                if (calendar) {
                    calendar.remove();
                }
                input.removeEventListener('click', toggleCalendar);
                input.removeEventListener('focus', openCalendar);
            }
        };
    });
};
